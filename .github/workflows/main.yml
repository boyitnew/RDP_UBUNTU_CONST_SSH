name: Ubuntu SSH

on:
  workflow_dispatch:

jobs:
  ubuntu-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: ูุนุงูโุณุงุฒ SSH ู ูพฺฉุฑุจูุฏ Root
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server

          # ูพฺฉุฑุจูุฏ SSH ุจุฑุง ูุฑูุฏ root ุจุง ุฑูุฒ ุนุจูุฑ
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

          # ุชูุธู ุฑูุฒ root
          echo "root:13691369" | sudo chpasswd

          # ุงุทููุงู ุงุฒ ูุฌูุฏ ูุณุฑูุง ูุงุฒู
          sudo mkdir -p /var/run/sshd /run/sshd
          sudo ssh-keygen -A  # ุชููุฏ ฺฉูุฏูุง ูุฒุจุงู

          # ุงุฌุฑุง sshd ุจูโุตูุฑุช ุฏุณุช ู ุจุฏูู PAM
          echo "โ ุฏุฑ ุญุงู ุฑุงูโุงูุฏุงุฒ SSHD..."
          sudo /usr/sbin/sshd -D -e &

          sleep 3
          if ! pgrep -x sshd > /dev/null; then
              echo "โ SSHD ุงุฌุฑุง ูุดุฏ โ ุจุฑุฑุณ ุฎุทุง"
              sudo /usr/sbin/sshd -D -e
              exit 1
          fi

          echo "โ ุณุฑูุณ SSH ุจุง ููููุช ุฑุงูโุงูุฏุงุฒ ุดุฏ"
          echo "SSH_CREDS=User: root | Password: 13691369" >> $GITHUB_ENV

      - name: ูุตุจ Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: ุจุฑูุฑุงุฑ ุงุชุตุงู Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-ssh-${{ github.run_id }} --accept-routes --ssh
          
          retries=0
          TSIP=""
          while [ -z "$TSIP" ] && [ $retries -lt 10 ]; do
              TSIP=$(tailscale ip -4 | head -n 1)
              sleep 5
              retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
              echo "โ ุขุฏุฑุณ IP ุชููโุงูุณฺฉูู ุชุฎุตุต ุฏุงุฏู ูุดุฏ."
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
          echo "โ ุขุฏุฑุณ IP ุชููโุงูุณฺฉูู: $TSIP"

      - name: ุชุฃุฏ ูุถุนุช SSH
        run: |
          echo "๐ ุจุฑุฑุณ ุณุฑูุณ SSH ุฑู IP: $TAILSCALE_IP"

          if ! pgrep -x sshd > /dev/null; then
              echo "โ ุณุฑูุณ SSH ูุนุงู ูุณุช"
              exit 1
          fi

          if ! sudo ss -tuln | grep -q ':22 '; then
              echo "โ SSH ุฑู ูพูุฑุช 22 ุฏุฑ ุญุงู ฺฏูุด ุฏุงุฏู ูุณุช"
              exit 1
          fi

          echo "โ ุณุฑูุณ SSH ุฏุฑ ูพูุฑุช 22 ูุนุงู ุงุณุช"

      - name: ุญูุธ ุงุชุตุงู ุชุง ุชููู ุฏุณุช
        run: |
          echo ""
          echo "=== ุงุทูุงุนุงุช ุฏุณุชุฑุณ SSH ==="
          echo "ุขุฏุฑุณ (IP): $TAILSCALE_IP"
          echo "ูุงู ฺฉุงุฑุจุฑ (Username): root"
          echo "ุฑูุฒ ุนุจูุฑ (Password): 13691369"
          echo "ูพูุฑุช (Port): 22"
          echo "============================"
          echo ""
          echo "๐ก ุจุฑุง ุงุชุตุงู ุงุฒ ุฏุณุชูุฑ ุฒุฑ ุงุณุชูุงุฏู ฺฉู:"
          echo "ssh root@$TAILSCALE_IP"
          echo ""
          
          while true; do
              echo "[$(date)] โ SSH ูุนุงู ุงุณุช - ุจุฑุง ุชูููุ Workflow ุฑุง Cancel ฺฉูุฏ"
              sleep 300
          done
