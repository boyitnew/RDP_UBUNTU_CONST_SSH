name: Ubuntu SSH

on:
  workflow_dispatch:

jobs:
  ubuntu-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: فعال‌سازی SSH و پیکربندی Root
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server

          # پیکربندی SSH برای ورود root با رمز عبور
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

          # تنظیم رمز root
          echo "root:13691369" | sudo chpasswd

          # اطمینان از وجود مسیرهای لازم
          sudo mkdir -p /var/run/sshd /run/sshd
          sudo ssh-keygen -A  # تولید کلیدهای میزبان

          # اجرای sshd به‌صورت دستی و بدون PAM
          echo "✅ در حال راه‌اندازی SSHD..."
          sudo /usr/sbin/sshd -D -e &

          sleep 3
          if ! pgrep -x sshd > /dev/null; then
              echo "❌ SSHD اجرا نشد — بررسی خطا"
              sudo /usr/sbin/sshd -D -e
              exit 1
          fi

          echo "✅ سرویس SSH با موفقیت راه‌اندازی شد"
          echo "SSH_CREDS=User: root | Password: 13691369" >> $GITHUB_ENV

      - name: نصب Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: برقراری اتصال Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-ssh-${{ github.run_id }} --accept-routes --ssh
          
          retries=0
          TSIP=""
          while [ -z "$TSIP" ] && [ $retries -lt 10 ]; do
              TSIP=$(tailscale ip -4 | head -n 1)
              sleep 5
              retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
              echo "❌ آدرس IP تِیل‌اِسکِیل تخصیص داده نشد."
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
          echo "✅ آدرس IP تِیل‌اِسکِیل: $TSIP"

      - name: تأیید وضعیت SSH
        run: |
          echo "🔍 بررسی سرویس SSH روی IP: $TAILSCALE_IP"

          if ! pgrep -x sshd > /dev/null; then
              echo "❌ سرویس SSH فعال نیست"
              exit 1
          fi

          if ! sudo ss -tuln | grep -q ':22 '; then
              echo "❌ SSH روی پورت 22 در حال گوش دادن نیست"
              exit 1
          fi

          echo "✅ سرویس SSH در پورت 22 فعال است"

      - name: حفظ اتصال تا توقف دستی
        run: |
          echo ""
          echo "=== اطلاعات دسترسی SSH ==="
          echo "آدرس (IP): $TAILSCALE_IP"
          echo "نام کاربری (Username): root"
          echo "رمز عبور (Password): 13691369"
          echo "پورت (Port): 22"
          echo "============================"
          echo ""
          echo "📡 برای اتصال از دستور زیر استفاده کن:"
          echo "ssh root@$TAILSCALE_IP"
          echo ""
          
          while true; do
              echo "[$(date)] ✅ SSH فعال است - برای توقف، Workflow را Cancel کنید"
              sleep 300
          done
